<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë°©ê¾¸ë¯¸ê¸°</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", sans-serif;
      }
      #unity-container {
        width: 100%;
       height: 100vh;
        margin: 0;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }
      #unity-canvas {
        width: 100%;
        height: 100%;
      }
      #loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
      }
    </style>
  </head>

  <body>
    <div id="unity-container">
      <div id="loading">ğŸ® Unity ë¡œë”© ì¤‘...</div>
      <canvas id="unity-canvas" style="display: none"></canvas>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
<<<<<<< HEAD
        // ========================================
        // Firebase ì„¤ì • í…ŒìŠ¤íŠ¸
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAM2Byx0gq7NiiNcpxaLNSlN7LCVQhqqBo",
            authDomain: "planithideout.firebaseapp.com",
            projectId: "planithideout",
            storageBucket: "planithideout.firebasestorage.app",
            messagingSenderId: "61513627379",
            appId: "1:61513627379:web:cce336f83c13c90a016986",
            measurementId: "G-T67KQM6V5G"
        };
=======
      // ========================================
      // Firebase ì„¤ì •
      // ========================================
      const firebaseConfig = {
        apiKey: "AIzaSyAM2Byx0gq7NiiNcpxaLNSlN7LCVQhqqBo",
        authDomain: "planithideout.firebaseapp.com",
        projectId: "planithideout",
        storageBucket: "planithideout.firebasestorage.app",
        messagingSenderId: "61513627379",
        appId: "1:61513627379:web:cce336f83c13c90a016986",
        measurementId: "G-T67KQM6V5G",
      };
>>>>>>> 6864c7b46fbc2612022febd2879f4ed0d03ea6f3

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      let userId = null;
      auth
        .signInAnonymously()
        .then((userCredential) => {
          userId = userCredential.user.uid;
          console.log("âœ… Firebase ë¡œê·¸ì¸ ì„±ê³µ:", userId);
        })
        .catch((error) => {
          console.error("âŒ Firebase ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
        });

      // ========================================
      // Unity WebGL ë¡œë”
      // ========================================
      let unityInstance = null;

      var buildUrl = "UnityBuild/Build";
      var loaderUrl = buildUrl + "/UnityBuild.loader.js";
      var config = {
        dataUrl: buildUrl + "/UnityBuild.data",
        frameworkUrl: buildUrl + "/UnityBuild.framework.js",
        codeUrl: buildUrl + "/UnityBuild.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "YourCompany",
        productName: "PlanitHideout",
        productVersion: "1.0",
      };

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(document.querySelector("#unity-canvas"), config)
          .then((instance) => {
            unityInstance = instance;
            document.getElementById("loading").style.display = "none";
            document.getElementById("unity-canvas").style.display = "block";
            console.log("âœ… Unity ë¡œë“œ ì™„ë£Œ");
          })
          .catch((message) => {
            alert("Unity ë¡œë“œ ì‹¤íŒ¨: " + message);
          });
      };
      document.body.appendChild(script);

      // ========================================
      // Unity â†” JavaScript í†µì‹ 
      // ========================================

      // Unityì—ì„œ í˜¸ì¶œ: ê·¸ë¦¬ë“œ ì¢Œí‘œ ì €ì¥ (ìƒˆ ë²„ì „)
      function SaveFurnitureGridPosition(furnitureId, gridX, gridY, gridZ) {
        if (!userId) {
          console.warn("âš ï¸ ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘...");
          return;
        }

        const gridPosition = {
          gridX: gridX,
          gridY: gridY,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
        };

        db.collection("users")
          .doc(userId)
          .collection("furniture")
          .doc(furnitureId)
          .set(gridPosition)
          .then(() => {
            console.log(`âœ… ${furnitureId} ê·¸ë¦¬ë“œ ì €ì¥: (${gridX}, ${gridY})`);
          })
          .catch((error) => {
            console.error(`âŒ ${furnitureId} ì €ì¥ ì‹¤íŒ¨:`, error);
          });
      }

      // ë ˆê±°ì‹œ: ì›”ë“œ ì¢Œí‘œ ì €ì¥ (ì‚¬ìš© ì•ˆ í•¨)
      function SaveFurniturePosition(furnitureId, posX, posY) {
        if (!userId) {
          console.warn("âš ï¸ ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘...");
          return;
        }

        const position = {
          x: posX,
          y: posY,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
        };

        db.collection("users")
          .doc(userId)
          .collection("furniture")
          .doc(furnitureId)
          .set(position)
          .then(() => {
            console.log(`âœ… ${furnitureId} ìœ„ì¹˜ ì €ì¥: (${posX.toFixed(2)}, ${posY.toFixed(2)})`);
          })
          .catch((error) => {
            console.error(`âŒ ${furnitureId} ì €ì¥ ì‹¤íŒ¨:`, error);
          });
      }

      // Unityì—ì„œ í˜¸ì¶œ: ê°€êµ¬ ìœ„ì¹˜ ë¡œë“œ ìš”ì²­
      function LoadFurniturePosition(furnitureId) {
        if (!userId || !unityInstance) {
          console.warn("âš ï¸ ì¤€ë¹„ ì¤‘...");
          return;
        }

        db.collection("users")
          .doc(userId)
          .collection("furniture")
          .doc(furnitureId)
          .get()
          .then((doc) => {
            if (doc.exists) {
              const data = doc.data();

              // ê·¸ë¦¬ë“œ ì¢Œí‘œë¡œ ì €ì¥ëœ ê²½ìš°
              if (data.gridX !== undefined && data.gridY !== undefined) {
                const jsonData = JSON.stringify({
                  id: furnitureId,
                  gridX: data.gridX,
                  gridY: data.gridY,
                });

                unityInstance.SendMessage("FurnitureManager", "SetFurniturePosition", jsonData);
                console.log(`ğŸ“¥ ${furnitureId} ê·¸ë¦¬ë“œ ìœ„ì¹˜ ë¡œë“œ: (${data.gridX}, ${data.gridY})`);
              }
              // ë ˆê±°ì‹œ: ì›”ë“œ ì¢Œí‘œë¡œ ì €ì¥ëœ ê²½ìš°
              else if (data.x !== undefined && data.y !== undefined) {
                const jsonData = JSON.stringify({
                  id: furnitureId,
                  x: data.x,
                  y: data.y,
                });

                unityInstance.SendMessage("FurnitureManager", "SetFurniturePosition", jsonData);
                console.log(
                  `ğŸ“¥ ${furnitureId} ìœ„ì¹˜ ë¡œë“œ: (${data.x.toFixed(2)}, ${data.y.toFixed(2)})`
                );
              }
            } else {
              console.log(`â„¹ï¸ ${furnitureId} ì €ì¥ëœ ìœ„ì¹˜ ì—†ìŒ`);
            }
          })
          .catch((error) => {
            console.error(`âŒ ${furnitureId} ë¡œë“œ ì‹¤íŒ¨:`, error);
          });
      }
    </script>
  </body>
</html>
